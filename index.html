<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controllo Servo Remoto</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #0066cc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
    }
    input[type="number"] {
      width: 50px;
    }
    .giorni input {
      width: auto;
    }
    #servoSlider {
      width: 100%;
    }
    .btn {
      margin: 5px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Controllo Servo</h1>
  <p>Angolo: <span id="servoVal">90</span>Â°</p>
  <input type="range" min="0" max="180" value="90" id="servoSlider" onchange="muoviServo(this.value)" />

  <br /><br />
  <button class="btn" onclick="aggiungiEvento()">+ Aggiungi evento</button>
  <button class="btn" onclick="applicaModifiche()">&#x1F4DD; Applica modifiche</button>
  <button class="btn" onclick="salvaEEPROM()">&#x1F4BE; Salva eventi su EEPROM</button>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Ora</th>
        <th>Minuto</th>
        <th>Angolo</th>
        <th>Giorni (D-L-M-M-G-V-S)</th>
        <th>Attivo</th>
      </tr>
    </thead>
    <tbody id="tabellaEventi"></tbody>
  </table>

  <script>
    function muoviServo(valore) {
      document.getElementById("servoVal").innerText = valore;
      fetch(`/set-servo?angle=${valore}`);
    }

    function aggiungiEvento() {
      const tbody = document.getElementById("tabellaEventi");
      const r = tbody.rows.length;
      const row = tbody.insertRow();

      row.innerHTML = `
        <td>${r}</td>
        <td><input type="number" min="0" max="23" value="0"></td>
        <td><input type="number" min="0" max="59" value="0"></td>
        <td><input type="number" min="0" max="180" value="90"></td>
        <td class="giorni">
          ${[...Array(7)].map((_, i) => `<input type="checkbox" value="${i}">`).join(" ")}
        </td>
        <td><input type="checkbox" checked></td>
      `;
    }

    function applicaModifiche() {
      const righe = document.querySelectorAll("#tabellaEventi tr");
      const eventi = [];

      righe.forEach((riga, i) => {
        const celle = riga.querySelectorAll("td");
        const ora = celle[1].querySelector("input").value;
        const minuto = celle[2].querySelector("input").value;
        const angolo = celle[3].querySelector("input").value;
        const giorni = celle[4].querySelectorAll("input[type=checkbox]");
        const attivo = celle[5].querySelector("input[type=checkbox]").checked ? 1 : 0;

        let bitmask = 0;
        giorni.forEach(g => {
          if (g.checked) bitmask |= (1 << parseInt(g.value));
        });

        eventi.push(`e${i}=${ora},${minuto},${angolo},${bitmask},${attivo}`);
      });

      const url = `/update-events?${eventi.join("&")}`;
      fetch(url);
    }

    function salvaEEPROM() {
      fetch("/salva");
    }

    window.onload = function () {
      fetch("/get-events")
        .then(r => r.json())
        .then(dati => {
          dati.forEach(ev => {
            aggiungiEvento();
            const r = document.querySelectorAll("#tabellaEventi tr").length - 1;
            const riga = document.querySelector(`#tabellaEventi tr:nth-child(${r + 1})`).children;

            riga[1].querySelector("input").value = ev.ora;
            riga[2].querySelector("input").value = ev.minuto;
            riga[3].querySelector("input").value = ev.angolo;

            const chk = riga[4].querySelectorAll("input");
            for (let i = 0; i < 7; i++) {
              if ((ev.giorni >> i) & 1) chk[i].checked = true;
            }

            riga[5].querySelector("input").checked = ev.attivo;
          });
        });
    };
  </script>
</body>
</html>
