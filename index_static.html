<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controllo Servo Remoto</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 1rem; }
    h1 { color: #007bff; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background-color: #eee; }
    input[type=range] { width: 100%; }
    .center { text-align: center; }
    button { padding: 0.5rem 1rem; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>Controllo Servo</h1>
  <div class="center">
    <label for="servoRange">Angolo: <span id="servoVal">90</span>Â°</label><br>
    <input type="range" id="servoRange" min="0" max="180" value="90">
  </div>
  <div class="center" style="margin-top:1rem;">
    <button onclick="salvaEventi()">ðŸ’¾ Salva eventi su EEPROM</button>
  </div>
  <table id="eventsTable">
    <thead>
      <tr>
        <th>#</th><th>Ora</th><th>Minuto</th><th>Angolo</th><th>Giorni (D-L-M-M-G-V-S)</th><th>Attivo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    const ip = "http://192.168.43.100";
    const servoRange = document.getElementById("servoRange");
    const servoVal = document.getElementById("servoVal");

    servoRange.addEventListener("input", e => {
      servoVal.textContent = e.target.value;
      fetch(`${ip}/set-servo?angle=${e.target.value}`);
    });

    function caricaEventi() {
      fetch(`${ip}/get-events`).then(r => r.json()).then(data => {
        const tbody = document.querySelector("#eventsTable tbody");
        tbody.innerHTML = "";
        data.forEach((ev, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${i+1}</td>
            <td><input type="number" min="0" max="23" id="ora-${i}" value="${ev.ora}"></td>
            <td><input type="number" min="0" max="59" id="min-${i}" value="${ev.minuto}"></td>
            <td><input type="number" min="0" max="180" id="angolo-${i}" value="${ev.angolo}"></td>
            <td>` + [...Array(7).keys()].map(d => ` <input type="checkbox" id="g-${i}-${d}" ${(ev.giorni >> d) & 1 ? 'checked' : ''}>`).join('') + `</td>
            <td><input type="checkbox" id="attivo-${i}" ${ev.attivo ? 'checked' : ''}></td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function salvaEventi() {
      const eventi = [];
      for (let i = 0; i < 50; i++) {
        const ora = +document.getElementById(`ora-${i}`)?.value || 0;
        const minuto = +document.getElementById(`min-${i}`)?.value || 0;
        const angolo = +document.getElementById(`angolo-${i}`)?.value || 0;
        let giorni = 0;
        for (let d = 0; d < 7; d++) {
          if (document.getElementById(`g-${i}-${d}`)?.checked) giorni |= (1 << d);
        }
        const attivo = document.getElementById(`attivo-${i}`)?.checked || false;
        eventi.push({ ora, minuto, giorni, angolo, attivo });
      }
      fetch(`${ip}/set-events`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(eventi)
      }).then(() => alert("Eventi inviati!"));
    }

    caricaEventi();
  </script>
</body>
</html>
